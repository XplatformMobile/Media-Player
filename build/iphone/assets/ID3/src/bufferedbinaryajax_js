var BinaryFile=require("./binaryfile"),BufferedBinaryAjax=function(t,e,n){function r(t,e,n,r,o,a,s){var u=i();if(u){var f=0;r&&!o&&(f=r[0]);var h=0;r&&(h=r[1]-r[0]+1),"undefined"==typeof s&&(s=!0),e&&("undefined"!=typeof u.onload?(u.onload=function(){"200"==u.status||"206"==u.status?(u.fileSize=a||u.getResponseHeader("Content-Length"),e(u)):n&&n({error:"xhr",xhr:u}),u=null},n&&(u.onerror=function(){n({error:"xhr",xhr:u}),u=null})):u.onreadystatechange=function(){4==u.readyState&&("200"==u.status||"206"==u.status?(u.fileSize=a||u.getResponseHeader("Content-Length"),e(u)):n&&n({error:"xhr",xhr:u}),u=null)}),u.open("GET",t,s),u.overrideMimeType&&u.overrideMimeType("text/plain; charset=x-user-defined"),r&&o&&u.setRequestHeader("Range","bytes="+r[0]+"-"+r[1]),u.setRequestHeader("If-Modified-Since","Sat, 01 Jan 1970 00:00:00 GMT"),u.send(null)}else n&&n({error:"Unable to create XHR object"})}function i(){var t=null;return"undefined"==typeof window?t=new(require("xmlhttprequest").XMLHttpRequest):window.XMLHttpRequest?t=new window.XMLHttpRequest:window.ActiveXObject&&(t=new window.ActiveXObject("Microsoft.XMLHTTP")),t}function o(t,e,n){var r=i();r?(e&&("undefined"!=typeof r.onload?(r.onload=function(){"200"==r.status||"206"==r.status?e(this):n&&n({error:"xhr",xhr:r}),r=null},n&&(r.onerror=function(){n({error:"xhr",xhr:r}),r=null})):r.onreadystatechange=function(){4==r.readyState&&("200"==r.status||"206"==r.status?e(this):n&&n({error:"xhr",xhr:r}),r=null)}),r.open("HEAD",t,!0),r.send(null)):n&&n({error:"Unable to create XHR object"})}function a(t,e,i,o){function a(t){var e=~~(t[0]/i)-o,n=~~(t[1]/i)+1+o;return 0>e&&(e=0),n>=blockTotal&&(n=blockTotal-1),[e,n]}function s(t){var e=a([t,t]);return u(e),c[~~(t/i)]}function u(o,a){for(;c[o[0]];)if(o[0]++,o[0]>o[1])return a?a():f;for(;c[o[1]];)if(o[1]--,o[0]>o[1])return a?a():f;var s=[o[0]*i,(o[1]+1)*i-1];r(t,function(t){var n=parseInt(t.getResponseHeader("Content-Length"),10);n==e&&(o[0]=0,o[1]=blockTotal-1,s[0]=0,s[1]=e-1);for(var r={data:t.responseBody||t.responseText,offset:s[0]},i=o[0];i<=o[1];i++)c[i]=r;h+=s[1]-s[0]+1,a&&a()},n,s,"bytes",f,!!a)}var f,h=0,g=new BinaryFile("",0,e),c=[];i=i||2048,o="undefined"==typeof o?0:o,blockTotal=~~((e-1)/i)+1;for(var d in g)g.hasOwnProperty(d)&&"function"==typeof g[d]&&(this[d]=g[d]);this.getByteAt=function(t){var e=s(t);return e&&"string"==typeof e.data?255&e.data.charCodeAt(t-e.offset):e&&"unknown"==typeof e.data?IEBinary_getByteAt(e.data,t-e.offset):""},this.getDownloadedBytesCount=function(){return h},this.loadRange=function(t,e){var n=a(t);u(n,e)}}function s(){o(t,function(n){var r=parseInt(n.getResponseHeader("Content-Length"),10)||-1;e(new a(t,r))},n)}s()};module.exports=BufferedBinaryAjax;